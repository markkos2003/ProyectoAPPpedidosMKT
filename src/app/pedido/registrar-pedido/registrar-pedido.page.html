<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-button (click)='volverMenu()'>
    <ion-icon slot="icon-only" name="arrow-back"></ion-icon> 
  </ion-button>
    <ion-title>REGISTRAR PEDIDO</ion-title>
  </ion-toolbar>
</ion-header>

<!--<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">registrar-pedido</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="form-container">-->
    <!-- Removed (ngSubmit)="registrarPedido()" -->
    <!--<form>-->

      <!-- Seleccionar Cliente -->
      <!--<ion-item>
        <ion-label position="floating">Seleccionar Cliente *</ion-label>
        <ion-select
          name="clienteId"
          interface="alert"
          required>-->
          <!-- Placeholder Option - Removed *ngFor -->
          <!--<ion-select-option   *ngFor="let clien of listaclientes" [value]="clien.id">{{clien.nombre}}</ion-select-option>-->
          <!--<ion-select-option value="2">Cliente B</ion-select-option>-->
        <!--</ion-select>
      </ion-item>-->

      <!-- Lista de productos agregados (Static placeholder - Removed *ngIf) -->
      <!--<div class="productos-section"  >
        <h3>Productos Agregados</h3>-->
        <!-- Placeholder Card - Removed *ngFor -->
        <!--<ion-card class="producto-card">
          <ion-card-content>
            <div class="producto-info">
              <div class="producto-detalle">
                <strong>Producto de Ejemplo</strong>
                <p>S/ 15.00 x 2</p>
                <p class="subtotal">Subtotal: S/ 30.00</p>
              </div>-->
              <!-- Removed (click)="eliminarItem(i)" -->
              <!--<ion-button fill="clear" color="danger">
                <ion-icon name="trash"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>-->

      <!-- Agregar Producto -->
      <!--<div class="agregar-producto-section">
        <h3>Agregar Producto</h3>-->

        <!--<ion-item>
          <ion-label position="floating">Producto</ion-label>
          <ion-select
            name="producto"
            interface="alert">-->
            <!-- Placeholder Options - Removed *ngFor -->
            <!--<ion-select-option 
             *ngFor="let produ of listaproductos">{{produ.nombre}}-S/{{produ.precio}}</ion-select-option>-->
            <!--<ion-select-option value="prod2">Item 2 - S/ 25.00</ion-select-option>-->
          <!--</ion-select>
        </ion-item>-->

        <!--<ion-item>
          <ion-label position="floating">Cantidad</ion-label>
          <ion-input
            type="number"
            name="cantidad"
            min="1">-->
            <!-- Removed [max] and [(ngModel)] -->
          <!--</ion-input>
        </ion-item>-->

        <!-- Removed (click) and [disabled] -->
        <!--<ion-button
          expand="block"
          fill="outline">
          <ion-icon slot="start" name="add-circle"></ion-icon>
          Agregar Producto
        </ion-button>
      </div>-->

      <!-- Total (Static placeholder - Removed *ngIf) -->
      <!--<div class="total-section">
        <h2>Total: S/ 150.00</h2>
      </div>-->

      <!-- Notas -->
      <!--<ion-item>
        <ion-label position="floating">Notas (Opcional)</ion-label>
        <ion-textarea
          name="notas"
          rows="3">-->
          <!-- Removed [(ngModel)] -->
        <!--</ion-textarea>
      </ion-item>-->

      <!-- Removed [disabled] -->
      <!--<ion-button
        expand="block"
        type="submit"
        class="submit-btn">
        REGISTRAR PEDIDO
      </ion-button>
    </form>
  </div>








</ion-content>-->



<ion-content class="ioncuerpo">
  <div [formGroup]="miFormulario">

  <div class="elegircliente" >
      <ion-item  class="clienteelecto">
          <ion-icon name="person-circle" slot="start" color="primary" size="large"></ion-icon>
          <ion-label position="stacked">CLIENTE/EMPRESA</ion-label>
          <ion-select  placeholder="Seleccionar..."
          formControlName="cliente">
            <ion-select-option *ngFor="let clien of listaclientes" [value]="clien">{{clien.nombre}}</ion-select-option>

          </ion-select>
      </ion-item>
  </div>

  <div class="filtros">



  </div>

  <div class="listahorizontal">
   
    <ion-card class="cardhorizontal" 
    *ngFor="let produ of listaproductos" 
    button="true" 
    [disabled]="esProductoSeleccionado(produ.id)"
    (click)="!esProductoSeleccionado(produ.id) && abrirModal(produ)">
       <ion-card-header>
            <img [src]="produ.imagen_url" alt="DescripciÃ³n de la imagen" class="imagenproducto"> 
            {{produ.nombre}}
       </ion-card-header>
       <ion-card-content>
        <p>S/ {{ produ.precio}}</p>

       </ion-card-content>
    </ion-card>
   
  </div>

  <ion-item class="metodopagos">
        <ion-label>Metodo de Pago*</ion-label>
        <ion-select 
          id="metodo-pedido"
          formControlName="metodopago"
          required 
          interface="popover">
          <ion-select-option >Efectivo</ion-select-option>
          <ion-select-option >Tarjeta</ion-select-option>
          <ion-select-option >Yape</ion-select-option>
        </ion-select>
  </ion-item>

  <ion-item>
        <ion-label position="floating">Notas (Opcional)</ion-label>
        <ion-textarea 
          formControlName="notas" 
          name="notas"
          rows="3">
        </ion-textarea>
      </ion-item>

  </div>
  
  <ion-item-divider>
    <ion-label>Resumen del pedido</ion-label>
  </ion-item-divider>

  <div *ngIf="productosseleccionados.length===0" class="mensaje-inicio">
    <ion-icon name="basket-outline"></ion-icon>
    <p>No hay productos seleccionados</p>
    <small>Selecciona un producto de arriba para comenzar</small>
  </div>

  <ion-list *ngIf="productosseleccionados.length >0">
    <ion-item-sliding *ngFor="let item of productosseleccionados;let i=index">
      <ion-item lines="full">
        <ion-label>
          <h2>{{item.nombreproducto}}</h2>
          <p>
            
              S: <b>{{ item.tallaselegidas.S || 0}}</b> |
              M: <b>{{ item.tallaselegidas.M || 0}}</b> | 
              L: <b>{{ item.tallaselegidas.L || 0}}</b> 
          </p>
          <p>
            {{ item.cantidad}} unid. x S/  {{ item.preciounitario}}
          </p>
        </ion-label>
        <ion-note slot="end" color="dark" style="font-weight: bold;">
           S/ {{ item.subtotal}}
        </ion-note>
      </ion-item>
      <ion-item-options>
        <ion-item-option color="danger" (click)="borrarItem(i)">
          <ion-icon name="trash"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
  </ion-list>

  

</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-grid>
      <ion-row>
        <ion-col size="6">
          <ion-button expand="block" color="medium" fill="outline" (click)="cancelarcarro()">
            CANCELAR
          </ion-button>
        </ion-col>
        <ion-col size="6">
          <ion-button expand="block" color="primary" 
          [disabled]="miFormulario.invalid || productosseleccionados.length===0"
          (click)="registrarPedidoFinal()">
            REGISTRAR PEDIDO ( S/{{totalGlobal}})
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-footer>

<ion-modal [isOpen]="modalAbierto" [breakpoints]="[0,0.5,0.75]" [initialBreakpoint]="0.5" (didDismiss)="cerrarModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title></ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModal()">X</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="productoTemporal">
        <p class="texto-centro-modal">Precio Unitario: <b>${{productoTemporal.precio}}</b></p>
        <ion-grid>
          <ion-row>
            <ion-col size="4" *ngFor="let talla of ['S','M','L']">
              <ion-label>Talla {{talla}}</ion-label>

              <p style="font-size: 12px; margin: 2px 0; color: gray;">
            Stock: <b>{{ productoTemporal.stock_por_talla[talla] || 0 }}</b>
              </p>

              <div class="input-talla">
                <ion-input type="number" 
                inputmode="numeric"
                [(ngModel)]="seleccionTemporal[talla]" 
                (keypress)="soloNumeros($event)"
                placeholder="0" 
                min="0"
                [max]="productoTemporal.stock_por_talla[talla] || 0">

                </ion-input>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
        <div class="modal-acciones ion-margin-top">
          <ion-button expand="block" (click)="agregarCarrito()">
             Listo - Agregar
          </ion-button>
        </div>
      </div>

    
    </ion-content>
  </ng-template>
</ion-modal>
